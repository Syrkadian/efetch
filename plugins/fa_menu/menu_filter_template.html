<html xmlns="http://www.w3.org/1999/xhtml" > 
<head > 
        <script src="/resources/jquery-1.11.3.min.js"></script>
        <script src="/resources/jquery-ui-1.11.4/jquery-ui.min.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="/resources/themes/default/easyui.css">
        <link rel="stylesheet" type="text/css" href="/resources/themes/icon.css">
        <link rel="stylesheet" type="text/css" href="/resources/themes/jquery.dataTables.min.css">
        <script type="text/javascript" src="/resources/jquery.easyui.min.js"></script>
        <script type="text/javascript" src="/resources/datagrid-detailview.js"></script>
    <style> 
        #<!-- Plugin -->_iframe {
            height: calc(100% - 28px);
            width: 100%;
            top:0; 
            bottom:0; 
            right:0;    
            left:0;
            border: 0px;
        }
        html{
            height: 100%;
        }

        body {
            min-height: 100%;
            margin: 0px;
        }
        .combo-panel {
            height: inherit !important;
        }
        #header {
            background-color:#EDF7FF;
            text-align:left;
            height: 28px;
            width: 100%;
        }
        #bottom {
            width: 100%;
        }
    </style>
</head> 
<body> 
    <div id="header">
        <div class="easyui-panel" id='filter_panel' style="width:100%;">
        </div>
        <!-- ADD EVIDENCE FORM -->
        <div id="add_evidence_window" class="easyui-window" title="Add Existing Evidence" data-options="closed:true,iconCls:'icon-add'" style="width:440px;height:400px;padding:10px;">
            <div style="padding:10px 10px 20px 10px">
                <form id="ff" action="/plugins/fa_case/?method=add_evidence&name=<!-- Case -->" method="post">
                    <table id="dg" title="" class="easyui-datagrid" style="width:100%;height:260px"
                            url="/plugins/fa_case/?method=get_evidence"
                            toolbar="#toolbar"
                            fitColumns="true" singleSelect="true">
                        <thead>
                            <tr>
                                <th field="evidence" width="100">Evidence</th>
                            </tr>
                        </thead>
                    </table>
                </form>

                <div style="text-align:center;padding:5px">
                    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitForm()">Submit</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="cancelForm()">Cancel</a>
                </div>
            </div>
         <!-- REMOVE EVIDENCE FORM -->
        <div id="remove_evidence_window" class="easyui-window" title="Remove Evidence" data-options="closed:true,iconCls:'icon-remove'" style="width:440px;height:400px;padding:10px;">
            <div style="padding:10px 10px 20px 10px">
                <form id="ff_remove" action="/plugins/fa_case/?method=remove_evidence&name=<!-- Case -->" method="post">
                    <table id="dg_remove" title="" class="easyui-datagrid" style="width:100%;height:260px"
                        url="/plugins/fa_case/?method=get_evidence&name=<!-- Case -->"
                            toolbar="#toolbar"
                            fitColumns="true" singleSelect="true">
                        <thead>
                            <tr>
                                <th field="evidence" width="100">Evidence</th>
                            </tr>
                        </thead>
                    </table>
                </form>

                <div style="text-align:center;padding:5px">
                    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="submitRemoveForm()">Remove</a>
                    <a href="javascript:void(0)" class="easyui-linkbutton" onclick="cancelRemoveForm()">Cancel</a>
                </div>
            </div>
        </div>
        </div>
        <script>
            var filters = <!-- Filters -->;
            reloadPanel();

            function submitForm(){
                var row = $('#dg').datagrid('getSelected');
                if (row){
                    var input = $("<input>")
                       .attr("type", "hidden")
                       .attr("name", "evidence").val(row.evidence);
                    $('#ff').append($(input));
                    $('#ff').form('submit');
                    $('#add_evidence_window').window('close');
                    setTimeout(function(){document.getElementById("<!-- Plugin -->_iframe").contentWindow.location.reload();}, 1000);
                }
            }

            function cancelForm(){
                $('#ff').form('clear');
                $('#add_evidence_window').window('close');
            }

            function submitRemoveForm(){
                var row = $('#dg_remove').datagrid('getSelected');
                if (row){
                    var input = $("<input>")
                       .attr("type", "hidden")
                       .attr("name", "evidence").val(row.evidence);
                    $('#ff_remove').append($(input));
                    $('#ff_remove').form('submit');
                    $('#remove_evidence_window').window('close');
                    setTimeout(function(){document.getElementById("<!-- Plugin -->_iframe").contentWindow.location.reload();}, 1000);
                }
            }

            function cancelRemoveForm(){
                $('#ff_remove').form('clear');
                $('#remove_evidence_window').window('close');
            }


            function addFilter(){
                console.log('HERE');
                var search = $('#search').combobox('getValue');
                var key = $('#key').combobox('getValue');
                var operation = $('#operation').combobox('getValue');
                var searchbox = $('#searchbox').val();
                var star = $('#star').switchbutton('options').checked;
                var start_datetime = $('#start_datetime').datetimebox('getValue');
                var end_datetime = $('#end_datetime').datetimebox('getValue');
                console.log('Data: Filters='+search);
                $.getJSON('/plugins/<!-- Plugin -->?method=add_filter&search='+search+
                    '&key='+key+'&operation='+operation+'&searchbox='+searchbox+
                    '&star='+star+'&start_datetime='+start_datetime+'&end_datetime='+end_datetime+
                    '&filters='+encodeURI(JSON.stringify(filters)),
                    function(data) { 
                        filters = data; 
                        console.log('NEW: Filters='+JSON.stringify(filters));
                        reloadPanel();
                        updateFilter();
                        });
            };
            function removeFilter(uid){
                console.log('Removing filter '+uid);
                console.log('OLD: Filters='+JSON.stringify(filters));
                filters = $.getJSON('/plugins/<!-- Plugin -->?method=remove_filter&uid='+uid+
                    '&filters='+encodeURI(JSON.stringify(filters)),
                    function(data) {
                        filters = data;
                        console.log('NEW: Filters='+JSON.stringify(filters));
                        reloadPanel();
                        updateFilter();
                    });
            };
            function updateFilter(){
                console.log('Updating filter');
                var filter = $.getJSON('/plugins/<!-- Plugin -->?method=get_filter&filters='+encodeURI(JSON.stringify(filters)),
                        function(data) {
                            filter = data;
                            var new_encoded_filter = encodeURI(JSON.stringify(filter));
                            var url = document.getElementById("<!-- Plugin -->_iframe").contentWindow.location.href;
                            
                            //Replaces existing filters or adds a new filter variable to child's url
                            if (url.indexOf('filter=') >= 0) {
                                var new_url = (url + '&').replace(/(filter=).*?(&)/,'$1' + new_encoded_filter + '$2');
                            }
                            else if (url.indexOf('?') >= 0) {
                                var new_url = url + '&filter=' + new_encoded_filter;
                            }
                            else {
                                var new_url = url + '?filter=' + new_encoded_filter;
                            }

                            document.getElementById("<!-- Plugin -->_iframe").src=new_url;            
                        }); 
            };
            function reloadPanel() {
                console.log('Reloading panel');
                console.log('CURR: Filters='+JSON.stringify(filters))
                $('#filter_panel').panel({ href:'/plugins/<!-- Plugin -->?method=get_panel_content&filters='+encodeURI(JSON.stringify(filters))});
            };
            function key_combobox_change(rec) {
                console.log('Change: ' + rec.value);
                $.getJSON('/plugins/<!-- Plugin -->?method=get_type_html&type='+rec.value,
                    function(data) {
                        console.log(data);
                        $('#value_fields').children().hide();
                        $('#' + data['field']).show();
                    });
            };

        </script>
    </div> 
    <div id="bottom"> 
        <iframe id="<!-- Plugin -->_iframe" src="<!-- Home -->"> 
        </iframe> 
    </div> 
</body> 
</html> 
