<!DOCTYPE html>
<html>
<head>
        <script src="/resources/jquery-1.11.3.min.js"></script>
        <script src="/resources/jquery-ui-1.11.4/jquery-ui.min.js" type="text/javascript"></script>
        <link rel="stylesheet" type="text/css" href="/resources/themes/default/easyui.css">
        <link rel="stylesheet" type="text/css" href="/resources/themes/icon.css">
        <link rel="stylesheet" type="text/css" href="/resources/themes/jquery.dataTables.min.css">
        <script type="text/javascript" src="/resources/jquery.easyui.min.js"></script>
        <script type="text/javascript" src="/resources/datagrid-detailview.js"></script>
        <script type="text/javascript" src="/resources/datagrid-scrollview.js"></script>
<style>
    html{
        height: 100%;
    }
    body {
        min-height: 100%;
        margin: 0px;
    }
    .layout-body {
        overflow: hidden;
    }
    #timeline_frame {
        height: 99%;
        width: 100%;
        border: none;
    }
    .datagrid-row{
        height:39px;
    }

</style>
</head>
    <body>
        <div class="easyui-layout" style="width:100%;height:100%;">
            <div data-options="region:'north',split:true" style="height:300px">
            <table id="tl01"  class="easyui-datagrid"  style="width:100%;height:100%;" data-options="url:'/plugins/<!-- Plugin -->/<!-- PID -->?mode=events<!-- Filter -->',view:scrollview,singleSelect:true,pageSize:30,fitColumns:true">
                <!-- Table -->
            </table>
            </div>
            <div data-options="region:'center'">
                <iframe name="timeline_frame" id="timeline_frame" target="self" src="<!-- Home -->"></iframe>
            </div>
        </div>
        <script type="text/javascript">
            $('#tl01').datagrid({loadMsg:''});

            function formatLinkUrl(val,row){
                if (row.meta_type == 'Directory') {
                    var url = '/plugins/<!-- Plugin -->/'+ row.pid + '<!-- Query -->';
                    return '<a href="'+url+'" target="_self">Navigate</a>';
                }
                else {
                    var url = '/plugins/<!-- Children -->'+row.pid;
                    return '<a href="'+url+'" target="timeline_frame">Open</a>';
                }
            }

            $(function(){
                $('#tl01').datagrid({
                    detailFormatter: function(rowIndex, rowData){
                        return "<div id='details_" + rowIndex +
                            "'>Loading...<\/div><script type=\"text/javascript\">$.get('/plugins/fa_timeline/" +
                            rowData.pid + "/?method=details&uuid=" + rowData.uuid +
                            "', function(data) { $('#details_" + rowIndex +
                            "').html(data); })<\/script>"
                    }
                });
            });

            function formatThumbnail(val,row){
                var url = '/plugins/fa_thumbnail/'+row.pid;
                return '<img style="height:32px;width:32px;" src="'+url+'" alt="Thumbnail">';
            }

            bookmark_version = 0
            if (typeof(Storage) !== "undefined") {
                if (localStorage.getItem("fa_star_version") === null) {
                    localStorage.setItem("fa_star_version", 0);
                }

                // Store
                bookmark_version = localStorage.getItem("fa_star_version");
            }

            $(window).bind('storage', function (e) {
                // Retrieve
                new_bookmark_version = localStorage.getItem("fa_star_version");

                if (new_bookmark_version != bookmark_version)
                {
                    bookmark_version = new_bookmark_version;
                    setTimeout(function() {
                        $('#tl01').datagrid("load");
                    }, 2000);
                }
            });

            function toggleStar(pid, img_id) {
                console.log('toggle started');
                $.get('/plugins/fa_togglestar/' + pid + '/?image_id=' + img_id, function(data) {
                    var json_data = JSON.parse(data)
                    $('#' + json_data.img_id).attr('src', json_data.img);
                    console.log('Found: ' + json_data);
                    if (typeof(Storage) !== "undefined") {
                        if (localStorage.getItem("fa_star_version") === null) {
                            localStorage.setItem("fa_star_version", 0);
                        }
                        else {
                            // Store
                            localStorage.setItem('fa_star_version', (Number(localStorage.getItem('fa_star_version')) + 1) % 10000);
                        }
                    }
                    console.log('version: ' + (localStorage.getItem('fa_star_version') + 1));
                })
                return false;
            }
        </script>
  </body>
</html>
